<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>US Election Simulator 2024 (Focused & Realistic)</title>

  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- D3 for SVG map & tooltips -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

  <!-- seedrandom for reproducible randomness -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #333;
      overflow-x: hidden;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    .game-header {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .game-title {
      font-size: 2rem;
      font-weight: bold;
      color: #1e3c72;
    }
    .stats-bar {
      display: flex;
      gap: 30px;
      align-items: center;
      flex-wrap: wrap;
    }
    .stat-item {
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #2a5298;
    }
    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }
    .main-content {
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      gap: 20px;
      min-height: 70vh;
    }
    .sidebar {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      height: fit-content;
    }
    .central-panel {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .section-title {
      font-size: 1.3rem;
      font-weight: bold;
      color: #1e3c72;
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 5px;
    }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin: 5px 0;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    .btn-primary {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    .btn-danger {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    .btn-success {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      color: #333;
    }
    .electoral-map {
      width: 100%;
      height: 400px;
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      position: relative;
      overflow: hidden;
    }
    .state-square {
      position: absolute;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .state-square:hover {
      transform: scale(1.1);
      z-index: 10;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .safe-d { background-color: #1e40af; color: white; }
    .lean-d { background-color: #60a5fa; color: white; }
    .toss-up { background-color: #fbbf24; color: #333; }
    .lean-r { background-color: #f87171; color: white; }
    .safe-r { background-color: #dc2626; color: white; }
    .poll-chart {
      height: 200px;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 10px;
    }
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .setup-form {
      display: grid;
      gap: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .form-label {
      font-weight: bold;
      color: #1e3c72;
    }
    .form-input, .form-select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      background: white;
    }
    .poll-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .poll-table th, .poll-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }
    .poll-table th {
      background: #f1f1f1;
      font-weight: bold;
      color: #1e3c72;
    }
    .spending-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin: 20px 0;
    }
    .spending-category {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #e0e0e0;
    }
    .spending-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #1e3c72;
    }
    .spending-slider {
      width: 100%;
      margin: 10px 0;
    }
    .spending-amount {
      font-weight: bold;
      color: #2a5298;
    }
    #tooltip {
      position: absolute;
      pointer-events: none;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      z-index: 10000;
      visibility: hidden;
    }

    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      .stats-bar {
        justify-content: center;
      }
    }
    @media (max-width: 768px) {
      .container { padding: 10px; }
      .game-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }
      .stats-bar { gap: 15px; }
      .electoral-map { height: 300px; }
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <div id="tooltip"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ---- 1) State Data ----
    const STATES_DATA = {
      AL: { name: 'Alabama', ev: 9, pvi: 15 },
      AK: { name: 'Alaska', ev: 3, pvi: 9 },
      AZ: { name: 'Arizona', ev: 11, pvi: 2 },
      AR: { name: 'Arkansas', ev: 6, pvi: 16 },
      CA: { name: 'California', ev: 54, pvi: -15 },
      CO: { name: 'Colorado', ev: 10, pvi: -4 },
      CT: { name: 'Connecticut', ev: 7, pvi: -7 },
      DE: { name: 'Delaware', ev: 3, pvi: -7 },
      FL: { name: 'Florida', ev: 30, pvi: 3 },
      GA: { name: 'Georgia', ev: 16, pvi: 3 },
      HI: { name: 'Hawaii', ev: 4, pvi: -18 },
      ID: { name: 'Idaho', ev: 4, pvi: 31 },
      IL: { name: 'Illinois', ev: 19, pvi: -8 },
      IN: { name: 'Indiana', ev: 11, pvi: 11 },
      IA: { name: 'Iowa', ev: 6, pvi: 6 },
      KS: { name: 'Kansas', ev: 6, pvi: 13 },
      KY: { name: 'Kentucky', ev: 8, pvi: 16 },
      LA: { name: 'Louisiana', ev: 8, pvi: 12 },
      ME: { name: 'Maine', ev: 4, pvi: -3 },
      MD: { name: 'Maryland', ev: 10, pvi: -13 },
      MA: { name: 'Massachusetts', ev: 11, pvi: -15 },
      MI: { name: 'Michigan', ev: 15, pvi: -1 },
      MN: { name: 'Minnesota', ev: 10, pvi: -2 },
      MS: { name: 'Mississippi', ev: 6, pvi: 11 },
      MO: { name: 'Missouri', ev: 10, pvi: 10 },
      MT: { name: 'Montana', ev: 4, pvi: 11 },
      NE: { name: 'Nebraska', ev: 5, pvi: 14 },
      NV: { name: 'Nevada', ev: 6, pvi: -1 },
      NH: { name: 'New Hampshire', ev: 4, pvi: -1 },
      NJ: { name: 'New Jersey', ev: 14, pvi: -6 },
      NM: { name: 'New Mexico', ev: 5, pvi: -3 },
      NY: { name: 'New York', ev: 28, pvi: -10 },
      NC: { name: 'North Carolina', ev: 16, pvi: 3 },
      ND: { name: 'North Dakota', ev: 3, pvi: 20 },
      OH: { name: 'Ohio', ev: 17, pvi: 6 },
      OK: { name: 'Oklahoma', ev: 7, pvi: 20 },
      OR: { name: 'Oregon', ev: 8, pvi: -6 },
      PA: { name: 'Pennsylvania', ev: 19, pvi: -1 },
      RI: { name: 'Rhode Island', ev: 4, pvi: -13 },
      SC: { name: 'South Carolina', ev: 9, pvi: 8 },
      SD: { name: 'South Dakota', ev: 3, pvi: 14 },
      TN: { name: 'Tennessee', ev: 11, pvi: 14 },
      TX: { name: 'Texas', ev: 40, pvi: 5 },
      UT: { name: 'Utah', ev: 6, pvi: 13 },
      VT: { name: 'Vermont', ev: 3, pvi: -16 },
      VA: { name: 'Virginia', ev: 13, pvi: -2 },
      WA: { name: 'Washington', ev: 12, pvi: -8 },
      WV: { name: 'West Virginia', ev: 4, pvi: 23 },
      WI: { name: 'Wisconsin', ev: 10, pvi: -1 },
      WY: { name: 'Wyoming', ev: 3, pvi: 25 },
      DC: { name: 'Washington DC', ev: 3, pvi: -43 }
    };

    // ---- 2) ISSUES & POSITIONS (unchanged) ----
    const ISSUES = [
      {
        id: 'economy',
        name: 'Economy',
        positions: [
          {
            id: 'progressive',
            name: 'Progressive Tax & Spending',
            effects: { young: 4, college: 3, urban: 3, rural: -2, business: -4 }
          },
          {
            id: 'moderate',
            name: 'Balanced Approach',
            effects: { moderate: 2, suburban: 2 }
          },
          {
            id: 'conservative',
            name: 'Tax Cuts & Deregulation',
            effects: { business: 4, rural: 3, wealthy: 4, young: -2, union: -3 }
          }
        ]
      },
      {
        id: 'healthcare',
        name: 'Healthcare',
        positions: [
          {
            id: 'medicare_all',
            name: 'Medicare for All',
            effects: { young: 5, black: 4, hispanic: 3, rural: -2, wealthy: -3 }
          },
          {
            id: 'public_option',
            name: 'Public Option',
            effects: { college: 3, suburban: 2, moderate: 3 }
          },
          {
            id: 'market_based',
            name: 'Market-based Solutions',
            effects: { business: 4, wealthy: 3, rural: 2, young: -3 }
          }
        ]
      },
      {
        id: 'immigration',
        name: 'Immigration',
        positions: [
          {
            id: 'pathway',
            name: 'Pathway to Citizenship',
            effects: { hispanic: 6, young: 3, urban: 3, rural: -3, white_nc: -2 }
          },
          {
            id: 'reform',
            name: 'Comprehensive Reform',
            effects: { moderate: 2, suburban: 1, college: 2 }
          },
          {
            id: 'enforcement',
            name: 'Border Security First',
            effects: { rural: 4, white_nc: 3, business: 2, hispanic: -4, young: -2 }
          }
        ]
      },
      {
        id: 'climate',
        name: 'Climate Change',
        positions: [
          {
            id: 'green_deal',
            name: 'Green New Deal',
            effects: { young: 5, college: 4, urban: 3, rural: -3, business: -2 }
          },
          {
            id: 'clean_energy',
            name: 'Clean Energy Investment',
            effects: { suburban: 3, moderate: 2, college: 2 }
          },
          {
            id: 'market_solutions',
            name: 'Market-based Solutions',
            effects: { business: 3, wealthy: 2, rural: 1, young: -2 }
          }
        ]
      },
      {
        id: 'guns',
        name: 'Gun Policy',
        positions: [
          {
            id: 'gun_control',
            name: 'Comprehensive Gun Control',
            effects: { urban: 4, black: 3, suburban: 2, rural: -4, white_nc: -2 }
          },
          {
            id: 'background_checks',
            name: 'Universal Background Checks',
            effects: { moderate: 3, suburban: 3, college: 2 }
          },
          {
            id: 'second_amendment',
            name: 'Protect 2nd Amendment',
            effects: { rural: 5, white_nc: 3, business: 2, urban: -3, black: -2 }
          }
        ]
      }
    ];

    // ---- 3) Poll Simulation Parameters ----
    // We simulate weekly polls with margin of error +/- 3%.
    const POLL_MOE = 3; // ±3%

    // ---- 4) GameState: realistic weekly loop ----
    class GameState {
      constructor() {
        this.rng = new Math.seedrandom('focused2024');
        this.reset();
      }

      reset() {
        this.gameStarted = false;
        this.currentWeek = 1;
        this.totalWeeks = 26; // 26 weeks ≈ 6 months
        this.candidate = {
          name: '',
          party: 'Democratic',
          funds: 5000000, // Start with $5M
          platform: {},
          trueSupport: {},   // underlying support per state
          pollingHistory: {},// { state: [latestPolls...] }
        };
        this.opponent = { name: 'Generic Opponent', party: 'Republican' };
        this.spendingThisWeek = 0; // ad budget for this week
        this.initializeTrueSupport();
        this.initializePollingHistory();
      }

      // Initial “true support” based on PVI only
      initializeTrueSupport() {
        Object.keys(STATES_DATA).forEach(state => {
          // Convert PVI+50 to approximate true Dem support:
          const base = 50 - STATES_DATA[state].pvi / 2;
          this.candidate.trueSupport[state] = base;
        });
      }

      // Keep a sliding array of last 3 weekly polls for each state
      initializePollingHistory() {
        Object.keys(STATES_DATA).forEach(state => {
          this.candidate.pollingHistory[state] = [];
        });
      }

      setPlatform(platform) {
        this.candidate.platform = platform;
        this.applyPlatformEffects();
      }

      // Platform gives a one-time bump to trueSupport at start
      applyPlatformEffects() {
        Object.keys(STATES_DATA).forEach(state => {
          let platformEffect = 0;
          Object.keys(this.candidate.platform).forEach(issueId => {
            const posId = this.candidate.platform[issueId];
            const issue = ISSUES.find(i => i.id === issueId);
            const posData = issue.positions.find(p => p.id === posId);
            if (posData && posData.effects) {
              // approximate effect by summing all demographic weights * 0.1
              const sumEffects = Object.values(posData.effects).reduce((a, b) => a + b, 0);
              platformEffect += sumEffects * 0.03; // smaller scale
            }
          });
          this.candidate.trueSupport[state] = Math.max(
            20,
            Math.min(80, this.candidate.trueSupport[state] + platformEffect)
          );
        });
      }

      // Each week:
      // 1) Fundraise
      // 2) Apply ad spending effect to trueSupport
      // 3) Conduct polls with MOE
      // 4) Advance week
      weeklyUpdate() {
        // 1) Fundraising: $300K base + momentum from past weeks
        const baseRaise = 300000;
        this.candidate.funds += baseRaise;

        // 2) Ad spending: assume the entire ad budget is evenly spread among toss-up states
        if (this.spendingThisWeek > 0) {
          const tossUps = this.getTossUpStates(5);
          const perStateSpend = this.spendingThisWeek / tossUps.length;
          tossUps.forEach(state => {
            // $1M → +0.5% trueSupport
            const bump = (perStateSpend / 1000000) * 0.5;
            this.candidate.trueSupport[state] = Math.max(
              20,
              Math.min(80, this.candidate.trueSupport[state] + bump)
            );
          });
        }

        // 3) Conduct weekly poll for each state
        Object.keys(STATES_DATA).forEach(state => {
          const truePct = this.candidate.trueSupport[state];
          // Simulate poll with uniform error ±MOE
          const error = (this.rng() - 0.5) * 2 * POLL_MOE;
          const polled = Math.max(0, Math.min(100, truePct + error));
          // Push into history (keep last 3)
          const arr = this.candidate.pollingHistory[state];
          if (arr.length >= 3) arr.shift();
          arr.push(polled);
        });

        // Reset weekly spending
        this.spendingThisWeek = 0;
        this.currentWeek++;
      }

      // Returns array of state abbreviations considered toss-up (margin < threshold)
      getTossUpStates(marginThreshold = 5) {
        return Object.keys(STATES_DATA).filter(state => {
          const arr = this.candidate.pollingHistory[state];
          if (!arr || arr.length === 0) return false;
          // Use average of last polls as current poll
          const avg =
            arr.reduce((a, b) => a + b, 0) / arr.length;
          return Math.abs(avg - 50) < marginThreshold;
        });
      }

      // Get current polling average for each state
      getCurrentPolls() {
        const current = {};
        Object.keys(STATES_DATA).forEach(state => {
          const arr = this.candidate.pollingHistory[state];
          if (!arr || arr.length === 0) {
            current[state] = this.candidate.trueSupport[state];
          } else {
            current[state] = arr.reduce((a, b) => a + b, 0) / arr.length;
          }
        });
        return current;
      }

      // Electoral vote tally based on current polls
      getElectoralTotals() {
        let demEV = 0,
          repEV = 0,
          tossEV = 0;
        const polls = this.getCurrentPolls();
        Object.keys(STATES_DATA).forEach(state => {
          const sd = STATES_DATA[state];
          const demPct = polls[state];
          let category = 'toss-up';
          if (demPct >= 52) category = 'lean-d';
          else if (demPct >= 55) category = 'safe-d';
          else if (demPct <= 48) category = 'lean-r';
          else if (demPct <= 45) category = 'safe-r';
          else category = 'toss-up';

          if (category === 'safe-d' || category === 'lean-d') demEV += sd.ev;
          else if (category === 'safe-r' || category === 'lean-r') repEV += sd.ev;
          else tossEV += sd.ev;
        });
        return { demEV, repEV, tossEV };
      }
    }

    const gameState = new GameState();

    // ---- 5) Setup Modal ----
    function SetupModal({ onStart }) {
      const [name, setName] = useState('');
      const [party, setParty] = useState('Democratic');
      const [platform, setPlatform] = useState({});

      useEffect(() => {
        const initial = {};
        ISSUES.forEach(issue => {
          initial[issue.id] = issue.positions[0].id;
        });
        setPlatform(initial);
      }, []);

      const handlePositionChange = (issueId, posId) => {
        setPlatform(prev => ({ ...prev, [issueId]: posId }));
      };

      const handleSubmit = () => {
        if (!name.trim()) return;
        onStart({ name: name.trim(), party, platform });
      };

      return (
        <div className="modal">
          <div className="modal-content">
            <h2>Candidate Setup</h2>
            <div className="setup-form">
              <div className="form-group">
                <label className="form-label">Candidate Name</label>
                <input
                  className="form-input"
                  type="text"
                  value={name}
                  onChange={e => setName(e.target.value)}
                />
              </div>
              <div className="form-group">
                <label className="form-label">Party</label>
                <select
                  className="form-select"
                  value={party}
                  onChange={e => setParty(e.target.value)}
                >
                  <option value="Democratic">Democratic</option>
                  <option value="Republican">Republican</option>
                  <option value="Independent">Independent</option>
                </select>
              </div>
              <div className="section-title">Build Your Platform</div>
              {ISSUES.map(issue => (
                <div key={issue.id} className="issue-group">
                  <div className="issue-title">{issue.name}</div>
                  <div className="position-options">
                    {issue.positions.map(pos => (
                      <label key={pos.id} className="position-option">
                        <input
                          type="radio"
                          name={issue.id}
                          value={pos.id}
                          checked={platform[issue.id] === pos.id}
                          onChange={() => handlePositionChange(issue.id, pos.id)}
                        />
                        {pos.name}
                      </label>
                    ))}
                  </div>
                </div>
              ))}
              <button className="btn btn-primary" onClick={handleSubmit}>
                Start Campaign
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ---- 6) Sidebar for Weekly Actions & News ----
    function Sidebar({ currentWeek, funds, onSpend, spendingThisWeek }) {
      const [adInput, setAdInput] = useState(0);

      const handleAllocate = () => {
        if (adInput < 0) return;
        if (adInput > funds) {
          alert('Not enough funds.');
          return;
        }
        onSpend(adInput);
        setAdInput(0);
      };

      return (
        <div className="sidebar">
          <div className="section-title">Week {currentWeek} Actions</div>
          <div>
            <p>
              <strong>Funds Available:</strong> ${funds.toLocaleString()}
            </p>
            <div className="spending-category">
              <div className="spending-title">Ad Spending This Week ($)</div>
              <input
                type="number"
                min="0"
                max={funds}
                step="10000"
                className="form-input"
                value={adInput}
                onChange={e => setAdInput(Number(e.target.value))}
              />
              <button className="btn btn-primary" onClick={handleAllocate}>
                Allocate Ads
              </button>
              {spendingThisWeek > 0 && (
                <p style={{ marginTop: '10px' }}>
                  Allocated ${spendingThisWeek.toLocaleString()}
                </p>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ---- 7) ElectoralMap with realistic polls + tooltips ----
    function ElectoralMap({ currentPolls }) {
      const ref = useRef();
      const tooltip = d3.select('#tooltip');

      useEffect(() => {
        const width = ref.current.clientWidth;
        const height = ref.current.clientHeight;
        const svg = d3
          .select(ref.current)
          .html('')
          .append('svg')
          .attr('width', width)
          .attr('height', height);

        const states = Object.keys(STATES_DATA);
        const cols = 12;
        const squareSize = width / cols;

        states.forEach((abbr, i) => {
          const row = Math.floor(i / cols);
          const col = i % cols;
          const x = col * squareSize;
          const y = row * squareSize;
          const demPct = currentPolls[abbr] || 50;
          let category = 'toss-up';
          if (demPct >= 55) category = 'safe-d';
          else if (demPct >= 52) category = 'lean-d';
          else if (demPct <= 45) category = 'safe-r';
          else if (demPct <= 48) category = 'lean-r';
          else category = 'toss-up';

          svg
            .append('rect')
            .attr('x', x + 1)
            .attr('y', y + 1)
            .attr('width', squareSize - 2)
            .attr('height', squareSize - 2)
            .attr('class', `state-square ${category}`)
            .on('mouseover', function (event) {
              d3.select(this).attr('stroke', '#000').attr('stroke-width', 2);
              const sd = STATES_DATA[abbr];
              const content = `
                <strong>${sd.name} (${abbr})</strong><br/>
                EV: ${sd.ev}<br/>
                Poll: ${currentPolls[abbr].toFixed(1)}% DEM`;
              tooltip
                .html(content)
                .style('visibility', 'visible')
                .style('left', event.pageX + 10 + 'px')
                .style('top', event.pageY + 10 + 'px');
            })
            .on('mousemove', function (event) {
              tooltip
                .style('left', event.pageX + 10 + 'px')
                .style('top', event.pageY + 10 + 'px');
            })
            .on('mouseout', function () {
              d3.select(this).attr('stroke', null);
              tooltip.style('visibility', 'hidden');
            });

          svg
            .append('text')
            .attr('x', x + squareSize / 2)
            .attr('y', y + squareSize / 2 + 5)
            .attr('text-anchor', 'middle')
            .attr('class', 'state-label')
            .text(abbr)
            .style('pointer-events', 'none')
            .style('font-size', squareSize * 0.3)
            .style('fill', '#fff');
        });
      }, [currentPolls]);

      return <div className="electoral-map" ref={ref}></div>;
    }

    // ---- 8) PollTable: show each state's polling ----
    function PollTable({ currentPolls }) {
      const states = Object.keys(STATES_DATA).sort((a, b) =>
        STATES_DATA[a].ev < STATES_DATA[b].ev ? 1 : -1
      ); // sort by EV descending

      return (
        <div>
          <div className="section-title">Detailed State Polls (avg of last 3)</div>
          <table className="poll-table">
            <thead>
              <tr>
                <th>State</th>
                <th>EV</th>
                <th>DEM%</th>
                <th>REP%</th>
              </tr>
            </thead>
            <tbody>
              {states.map(abbr => (
                <tr key={abbr}>
                  <td>{abbr}</td>
                  <td>{STATES_DATA[abbr].ev}</td>
                  <td>{currentPolls[abbr].toFixed(1)}</td>
                  <td>{(100 - currentPolls[abbr]).toFixed(1)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    }

    // ---- 9) Main App ----
    function App() {
      const [started, setStarted] = useState(gameState.gameStarted);
      const [funds, setFunds] = useState(0);
      const [currentWeek, setCurrentWeek] = useState(1);
      const [spendingThisWeek, setSpendingThisWeek] = useState(0);
      const [currentPolls, setCurrentPolls] = useState({});
      const [electorals, setElectorals] = useState({ demEV: 0, repEV: 0, tossEV: 0 });

      // Start campaign
      const handleStart = ({ name, party, platform }) => {
        gameState.reset();
        gameState.gameStarted = true;
        gameState.candidate.name = name;
        gameState.candidate.party = party;
        gameState.setPlatform(platform);

        setFunds(gameState.candidate.funds);
        setCurrentWeek(gameState.currentWeek);
        // Before first poll, we do an initial weekly update to populate polls
        gameState.weeklyUpdate();
        updateAfterWeek();
        setStarted(true);
      };

      // Update local state after each weeklyUpdate
      const updateAfterWeek = () => {
        const polls = gameState.getCurrentPolls();
        setCurrentPolls(polls);

        const ev = gameState.getElectoralTotals();
        setElectorals(ev);

        setFunds(gameState.candidate.funds);
        setCurrentWeek(gameState.currentWeek);
        setSpendingThisWeek(gameState.spendingThisWeek);
      };

      // Handle spending allocation for the week
      const handleSpend = amount => {
        gameState.spendingThisWeek = amount;
        gameState.candidate.funds -= amount;
        setFunds(gameState.candidate.funds);
        setSpendingThisWeek(amount);
      };

      // Advance to next week
      const advanceWeek = () => {
        gameState.weeklyUpdate();
        updateAfterWeek();
      };

      if (!started) {
        return <SetupModal onStart={handleStart} />;
      }

      return (
        <div className="container">
          <div className="game-header">
            <div className="game-title">
              {gameState.candidate.name} ({gameState.candidate.party})
            </div>
            <div className="stats-bar">
              <div className="stat-item">
                <div className="stat-value">${funds.toLocaleString()}</div>
                <div className="stat-label">Funds</div>
              </div>
              <div className="stat-item">
                <div className="stat-value">Week {currentWeek}</div>
                <div className="stat-label">Campaign Week</div>
              </div>
              <div className="stat-item">
                <div className="stat-value">
                  {electorals.demEV}D / {electorals.repEV}R / {electorals.tossEV}T
                </div>
                <div className="stat-label">Electoral Votes</div>
              </div>
              <button className="btn btn-danger" onClick={advanceWeek}>
                Advance Week
              </button>
            </div>
          </div>

          <div className="main-content">
            <Sidebar
              currentWeek={currentWeek}
              funds={funds}
              onSpend={handleSpend}
              spendingThisWeek={spendingThisWeek}
            />

            <div className="central-panel">
              <ElectoralMap currentPolls={currentPolls} />
              <PollTable currentPolls={currentPolls} />
            </div>

            <div className="sidebar">
              <div className="section-title">Instructions</div>
              <p>
                Each week you may allocate some of your funds to state‐level ad buys
                (allocate to toss‐up states only). Those ads shift your underlying
                “true support” in those states by +0.5% for every \$1 million spent.
              </p>
              <p>
                Polls are conducted weekly with a ±3% margin of error. The displayed poll
                is the average of the last three weekly polls.
              </p>
              <p>
                Electoral vote totals update based on current polling:  
                • Safe/D/Lean/D states for you count toward your side.  
                • Toss‐ups remain uncalled.
              </p>
              <p>
                Advance week to see fundraising, ad effects, and new polls.
              </p>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
