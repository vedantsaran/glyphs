<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>City Transit Tycoon</title>

  <!-- React & ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- D3.js for maps & charts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

  <!-- seedrandom for reproducible randomness -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>

  <style>
    :root {
      --bg-gradient-1: #0f2027;
      --bg-gradient-2: #203a43;
      --bg-gradient-3: #2c5364;
      --panel-bg: rgba(255,255,255,0.9);
      --accent: #1e90ff;
      --accent-dark: #1c7ed6;
      --text-dark: #333;
      --text-light: #fff;
      --shadow-glow: rgba(0, 0, 0, 0.2);
      --font-primary: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: var(--font-primary);
      background: linear-gradient(135deg, var(--bg-gradient-1), var(--bg-gradient-2), var(--bg-gradient-3));
      color: var(--text-dark);
      overflow-x: hidden;
    }
    .container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .header {
      background: var(--panel-bg);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      box-shadow: 0 5px 20px var(--shadow-glow);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .header-title {
      font-size: 2rem;
      font-weight: bold;
      color: var(--accent);
      text-shadow: 1px 1px 4px var(--shadow-glow);
    }
    .stats-bar {
      display: flex;
      gap: 30px;
      align-items: center;
      flex-wrap: wrap;
    }
    .stat-item {
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent-dark);
    }
    .stat-label {
      font-size: 0.9rem;
      color: #555;
    }
    .main-content {
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      gap: 20px;
      margin-top: 20px;
      min-height: 70vh;
    }
    .sidebar, .right-panel {
      background: var(--panel-bg);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 20px var(--shadow-glow);
      height: fit-content;
    }
    .central-panel {
      background: var(--panel-bg);
      backdrop-filter: blur(10px);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 5px 20px var(--shadow-glow);
      display: flex;
      flex-direction: column;
      gap: 20px;
      overflow-y: auto;
    }
    .section-title {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 5px;
    }
    .btn {
      background: var(--accent);
      color: var(--text-light);
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px var(--shadow-glow);
      margin-top: 10px;
    }
    .btn:hover {
      background: var(--accent-dark);
      box-shadow: 0 5px 15px var(--shadow-glow);
    }
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px var(--shadow-glow);
    }
    .form-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
    }
    .form-label {
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 5px;
    }
    .form-input, .form-select {
      padding: 10px;
      border: 2px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }
    .map-container {
      width: 100%;
      height: 400px;
      position: relative;
    }
    .network-graph {
      width: 100%;
      height: 300px;
      background: #fafafa;
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 10px;
    }
    .chart {
      width: 100%;
      height: 200px;
      background: #fafafa;
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 10px;
    }
    .fleet-table, .station-table, .event-log {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .fleet-table th, .fleet-table td,
    .station-table th, .station-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }
    .fleet-table th, .station-table th {
      background: #f1f1f1;
      color: var(--accent);
      font-weight: bold;
    }
    .event-log {
      max-height: 200px;
      overflow-y: auto;
      background: #fafafa;
      border-radius: 10px;
      border: 1px solid #ddd;
      padding: 10px;
    }
    .event-item {
      margin-bottom: 8px;
      font-size: 0.9rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    #tooltip {
      position: absolute;
      pointer-events: none;
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      z-index: 10000;
      visibility: hidden;
    }

    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      .stats-bar {
        justify-content: center;
      }
    }
    @media (max-width: 768px) {
      .container { padding: 10px; }
      .header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }
      .stats-bar { gap: 15px; }
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <div id="tooltip"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // ----------- 1) Core GameState Singleton -----------
    class GameState {
      constructor() {
        this.rng = new Math.seedrandom('tycoon2024');
        this.reset();
      }

      reset() {
        // Time (in months, 1..120)
        this.currentMonth = 1;
        this.maxMonths = 120;
        this.gameOver = false;

        // Company Info
        this.companyName = '';
        this.cash = 5_000_000;   // $5M starting capital
        this.revenue = 0;
        this.expenses = 0;
        this.monthlyProfit = 0;

        // City & Demand
        this.cityPopulation = 200_000;    // starting population
        this.monthlyGrowthRate = 0.005;   // 0.5% base
        this.baseRidershipPct = 0.15;     // 15% of population uses transit initially

        // Fleet & Routes
        this.fleet = [];      // array of { id, type, capacity, speed, maintenanceCost, status }
        this.nextFleetId = 1;
        this.routes = [];     // array of { id, name, stops: [stationIds], length, type, fare, assignedFleetId }
        this.nextRouteId = 1;

        // Stations
        this.stations = [];   // { id, name, x, y, maintenanceCost }
        this.nextStationId = 1;

        // Events Log
        this.log = [];

        // Performance metrics (for charts)
        this.history = {
          months: [],
          profits: [],
          ridership: [],
          cash: []
        };

        // Initialize demand nodes
        this.initializeStations();

        // --- initial logging ---
        this.logEvent("Game started. Welcome to City Transit Tycoon!");
      }

      initializeStations() {
        // Pre‐place 10 random stations on a 500×500 grid
        this.stations = [];
        for (let i = 0; i < 10; i++) {
          const x = Math.floor(this.rng() * 500);
          const y = Math.floor(this.rng() * 500);
          this.stations.push({
            id: this.nextStationId++,
            name: `Station ${i + 1}`,
            x, y,
            maintenanceCost: 2000  // monthly
          });
        }
      }

      logEvent(text) {
        const month = this.currentMonth;
        this.log.unshift({ month, text });
        if (this.log.length > 100) this.log.pop();
      }

      advanceMonth() {
        if (this.gameOver) return;
        // 1) City population grows
        this.cityPopulation = Math.round(
          this.cityPopulation * (1 + this.monthlyGrowthRate + (this.rng() - 0.5) * 0.005)
        );

        // 2) Compute ridership demand
        const totalCapacity = this.fleet.reduce((sum, f) => {
          if (f.status === 'active') return sum + f.capacity * f.frequency;
          return sum;
        }, 0);
        const potentialRiders = Math.round(
          this.cityPopulation * (this.baseRidershipPct + (this.fleet.length * 0.005))
        );
        const actualRidership = Math.min(potentialRiders, totalCapacity);

        // 3) Revenue = ridership × average fare
        const avgFare =
          this.routes.length > 0
            ? this.routes.reduce((s, r) => s + r.fare, 0) / this.routes.length
            : 0;
        this.revenue = actualRidership * avgFare;

        // 4) Expenses = maintenance of fleet + stations + staff (10% of revenue)
        const fleetMaintenance = this.fleet.reduce((s, f) => s + (f.status === 'active' ? f.maintenanceCost : 0), 0);
        const stationMaintenance = this.stations.reduce((s, st) => s + st.maintenanceCost, 0);
        const staffCosts = this.revenue * 0.1;
        this.expenses = fleetMaintenance + stationMaintenance + staffCosts;

        // 5) Profit & update cash
        this.monthlyProfit = this.revenue - this.expenses;
        this.cash += this.monthlyProfit;

        // 6) Record history for charts
        this.history.months.push(this.currentMonth);
        this.history.profits.push(this.monthlyProfit);
        this.history.ridership.push(actualRidership);
        this.history.cash.push(this.cash);

        // 7) Check losing condition
        if (this.cash < 0) {
          this.logEvent("Bankruptcy! You’ve run out of cash.");
          this.gameOver = true;
        }

        // 8) Increment month
        this.currentMonth++;
        if (this.currentMonth > this.maxMonths) {
          this.logEvent("Game Over! Reached maximum months.");
          this.gameOver = true;
        }
      }

      // ---------------- Fleet Management ----------------
      buyFleet(type) {
        // Types: 'Bus', 'Tram', 'Subway'
        const specs = {
          Bus: { capacity: 40, speed: 40, cost: 100_000, maintenance: 2000 },
          Tram: { capacity: 100, speed: 60, cost: 500_000, maintenance: 5000 },
          Subway: { capacity: 300, speed: 80, cost: 2_000_000, maintenance: 20000 }
        };
        const s = specs[type];
        if (!s) return false;
        if (this.cash < s.cost) return false;
        this.cash -= s.cost;
        this.fleet.push({
          id: this.nextFleetId++,
          type,
          capacity: s.capacity,
          speed: s.speed,
          maintenanceCost: s.maintenance,
          status: 'active',
          frequency: 1  // runs once per month by default
        });
        this.logEvent(`Purchased new ${type} (#${this.nextFleetId - 1})`);
        return true;
      }

      retireFleet(fleetId) {
        const idx = this.fleet.findIndex(f => f.id === fleetId);
        if (idx === -1) return false;
        const f = this.fleet[idx];
        this.fleet.splice(idx, 1);
        this.logEvent(`Retired ${f.type} (#${fleetId})`);
        return true;
      }

      upgradeFleetFrequency(fleetId) {
        const f = this.fleet.find(f => f.id === fleetId && f.status === 'active');
        if (!f) return false;
        const upgradeCost = 50000 * f.frequency; // scaling cost
        if (this.cash < upgradeCost) return false;
        this.cash -= upgradeCost;
        f.frequency += 1;
        this.logEvent(`Increased frequency of ${f.type} (#${fleetId}) to ${f.frequency} runs/month`);
        return true;
      }

      // ---------------- Station Management ----------------
      buildStation(x, y) {
        const cost = 300_000;
        if (this.cash < cost) return false;
        this.cash -= cost;
        this.stations.push({
          id: this.nextStationId++,
          name: `Station ${this.nextStationId - 1}`,
          x, y,
          maintenanceCost: 3000
        });
        this.logEvent(`Built new station (#${this.nextStationId - 1})`);
        return true;
      }

      upgradeStation(stationId) {
        const st = this.stations.find(s => s.id === stationId);
        if (!st) return false;
        const cost = 200_000;
        if (this.cash < cost) return false;
        this.cash -= cost;
        st.maintenanceCost += 500; // incremental
        this.logEvent(`Upgraded station (#${stationId})`);
        return true;
      }

      // ---------------- Route Management ----------------
      createRoute(name, stops, type) {
        // stops = [stationId1, stationId2, ...], type = 'Bus'|'Tram'|'Subway'
        const cost = type === 'Bus' ? 0 : type === 'Tram' ? 200_000 : 1_000_000;
        if (this.cash < cost) return false;
        this.cash -= cost;
        const route = {
          id: this.nextRouteId++,
          name,
          stops: [...stops], 
          length: stops.length, // simplistic
          type,
          fare: type === 'Bus' ? 2 : type === 'Tram' ? 3 : 5,
          assignedFleetId: null
        };
        this.routes.push(route);
        this.logEvent(`Created new ${type} route "${name}" (#${route.id})`);
        return true;
      }

      assignFleetToRoute(routeId, fleetId) {
        const rt = this.routes.find(r => r.id === routeId);
        const fl = this.fleet.find(f => f.id === fleetId);
        if (!rt || !fl || rt.type !== fl.type || rt.assignedFleetId === fleetId) return false;
        rt.assignedFleetId = fleetId;
        this.logEvent(`Assigned ${fl.type} (#${fleetId}) to route "${rt.name}"`);
        return true;
      }

      // ---------------- Monthly Events ----------------
      randomEvent() {
        if (this.gameOver) return;
        // 5% chance per month
        if (this.rng() < 0.05) {
          const events = [
            'Fuel price spike increases maintenance costs by 10% this month.',
            'City implements subsidy: +$100K revenue boost this month.',
            'Major storm damages 2 random stations (extra $50K repair).',
            'Ridership boost from festival: +20% ridership this month.',
            'Competitor lowers fares: your ridership drops 5%.'
          ];
          const choice = events[Math.floor(this.rng() * events.length)];
          this.handleEvent(choice);
        }
      }

      handleEvent(description) {
        if (description.includes('Fuel price')) {
          // Increase all maintenance costs by 10% temporarily
          this.fleet.forEach(f => (f.maintenanceCost *= 1.1));
          this.stations.forEach(s => (s.maintenanceCost *= 1.1));
        } else if (description.includes('subsidy')) {
          this.cash += 100_000;
        } else if (description.includes('storm')) {
          // pick 2 random stations
          if (this.stations.length >= 2) {
            const idxs = [];
            while (idxs.length < 2) {
              const r = Math.floor(this.rng() * this.stations.length);
              if (!idxs.includes(r)) idxs.push(r);
            }
            idxs.forEach(i => (this.cash -= 50000));
          }
        } else if (description.includes('festival')) {
          this.baseRidershipPct += 0.05; // +5%
        } else if (description.includes('competitor')) {
          this.baseRidershipPct -= 0.05; // −5%
        }
        this.logEvent(`EVENT: ${description}`);
      }
    }

    const gameState = new GameState();

    // ----------- 2) Components -----------

    // 2.1) SetupModal: company name, initial setup
    function SetupModal({ onStart }) {
      const [name, setName] = useState('');
      const handleSubmit = () => {
        if (!name.trim()) return;
        gameState.companyName = name.trim();
        onStart();
      };
      return (
        <div className="modal">
          <div className="modal-content">
            <h2>Welcome, Transit Tycoon!</h2>
            <div className="form-group">
              <label className="form-label">Company Name</label>
              <input
                className="form-input"
                type="text"
                placeholder="Enter your company name"
                value={name}
                onChange={e => setName(e.target.value)}
              />
            </div>
            <button className="btn btn-primary" onClick={handleSubmit}>
              Start New Game
            </button>
          </div>
        </div>
      );
    }

    // 2.2) SidebarControls: build stations, buy fleet, create routes
    function SidebarControls({ refresh }) {
      const [stationX, setStationX] = useState(250);
      const [stationY, setStationY] = useState(250);
      const [fleetType, setFleetType] = useState('Bus');
      const [routeName, setRouteName] = useState('');
      const [routeType, setRouteType] = useState('Bus');
      const [routeStops, setRouteStops] = useState('');

      // Build Station
      const handleBuildStation = () => {
        const success = gameState.buildStation(Number(stationX), Number(stationY));
        if (!success) alert('Not enough cash ($300K).');
        refresh();
      };

      // Buy Fleet
      const handleBuyFleet = () => {
        const success = gameState.buyFleet(fleetType);
        if (!success) alert('Not enough cash.');
        refresh();
      };

      // Create Route
      const handleCreateRoute = () => {
        // routeStops as comma‐separated station IDs
        const stops = routeStops
          .split(',')
          .map(s => Number(s.trim()))
          .filter(n => !isNaN(n));
        const success = gameState.createRoute(routeName.trim(), stops, routeType);
        if (!success) alert('Failed: Check cash or invalid stops.');
        refresh();
      };

      return (
        <div className="sidebar">
          <div className="section-title">Build & Fleet</div>
          <div className="form-group">
            <label className="form-label">New Station (x,y)</label>
            <div style={{ display: 'flex', gap: '10px' }}>
              <input
                className="form-input"
                type="number"
                placeholder="X"
                value={stationX}
                onChange={e => setStationX(e.target.value)}
                style={{ width: '80px' }}
              />
              <input
                className="form-input"
                type="number"
                placeholder="Y"
                value={stationY}
                onChange={e => setStationY(e.target.value)}
                style={{ width: '80px' }}
              />
            </div>
            <button className="btn btn-success" onClick={handleBuildStation}>
              Build Station ($300K)
            </button>
          </div>

          <div className="form-group">
            <label className="form-label">Buy Fleet</label>
            <select
              className="form-select"
              value={fleetType}
              onChange={e => setFleetType(e.target.value)}
            >
              <option value="Bus">Bus ($100K)</option>
              <option value="Tram">Tram ($500K)</option>
              <option value="Subway">Subway ($2M)</option>
            </select>
            <button className="btn btn-success" onClick={handleBuyFleet}>
              Purchase
            </button>
          </div>

          <div className="form-group">
            <label className="form-label">Create Route</label>
            <input
              className="form-input"
              type="text"
              placeholder="Route Name"
              value={routeName}
              onChange={e => setRouteName(e.target.value)}
            />
            <select
              className="form-select"
              value={routeType}
              onChange={e => setRouteType(e.target.value)}
            >
              <option value="Bus">Bus</option>
              <option value="Tram">Tram</option>
              <option value="Subway">Subway</option>
            </select>
            <input
              className="form-input"
              type="text"
              placeholder="Stops: e.g. 1,2,3"
              value={routeStops}
              onChange={e => setRouteStops(e.target.value)}
            />
            <button className="btn btn-success" onClick={handleCreateRoute}>
              Create Route
            </button>
          </div>
        </div>
      );
    }

    // 2.3) StationPanel: lists stations and allows upgrades
    function StationPanel({ refresh }) {
      const [upgradeId, setUpgradeId] = useState(null);
      const stations = gameState.stations;

      const handleUpgrade = (id) => {
        const success = gameState.upgradeStation(id);
        if (!success) alert('Not enough cash ($200K).');
        refresh();
      };

      return (
        <div className="right-panel">
          <div className="section-title">Stations</div>
          <table className="station-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Maint Cost</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {stations.map(st => (
                <tr key={st.id}>
                  <td>{st.id}</td>
                  <td>{st.name}</td>
                  <td>${st.maintenanceCost.toLocaleString()}</td>
                  <td>
                    <button className="btn btn-primary" onClick={() => handleUpgrade(st.id)}>
                      Upgrade ($200K)
                    </button>
                  </td>
                </tr>
              ))}
              {stations.length === 0 && (
                <tr>
                  <td colSpan="4">No stations built yet.</td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      );
    }

    // 2.4) FleetPanel: lists fleet and allows retire/upgrades
    function FleetPanel({ refresh }) {
      const [selectedFleet, setSelectedFleet] = useState(null);
      const fleet = gameState.fleet;

      const handleRetire = (id) => {
        gameState.retireFleet(id);
        refresh();
      };

      const handleUpgradeFreq = (id) => {
        const success = gameState.upgradeFleetFrequency(id);
        if (!success) alert('Not enough cash or invalid.');
        refresh();
      };

      return (
        <div className="right-panel" style={{ marginTop: '20px' }}>
          <div className="section-title">Fleet</div>
          <table className="fleet-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Capacity</th>
                <th>Freq</th>
                <th>Maint</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {fleet.map(f => (
                <tr key={f.id}>
                  <td>{f.id}</td>
                  <td>{f.type}</td>
                  <td>{f.capacity}</td>
                  <td>{f.frequency}/mo</td>
                  <td>${f.maintenanceCost.toLocaleString()}</td>
                  <td>
                    <button className="btn btn-primary" onClick={() => handleUpgradeFreq(f.id)}>
                      +Freq (${(50000 * f.frequency).toLocaleString()})
                    </button>
                    <button className="btn btn-danger" onClick={() => handleRetire(f.id)} style={{ marginLeft: '5px' }}>
                      Retire
                    </button>
                  </td>
                </tr>
              ))}
              {fleet.length === 0 && (
                <tr>
                  <td colSpan="6">No vehicles purchased yet.</td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      );
    }

    // 2.5) RoutePanel: lists routes and assign fleet
    function RoutePanel({ refresh }) {
      const [assignFleetId, setAssignFleetId] = useState('');
      const [assignRouteId, setAssignRouteId] = useState('');

      const routes = gameState.routes;
      const fleet = gameState.fleet;

      const handleAssign = () => {
        const fId = Number(assignFleetId);
        const rId = Number(assignRouteId);
        const success = gameState.assignFleetToRoute(rId, fId);
        if (!success) alert('Assign failed (mismatch type or invalid).');
        refresh();
      };

      return (
        <div className="right-panel" style={{ marginTop: '20px' }}>
          <div className="section-title">Routes</div>
          <table className="fleet-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Type</th>
                <th>Fare</th>
                <th>Assigned</th>
              </tr>
            </thead>
            <tbody>
              {routes.map(r => (
                <tr key={r.id}>
                  <td>{r.id}</td>
                  <td>{r.name}</td>
                  <td>{r.type}</td>
                  <td>${r.fare}</td>
                  <td>{r.assignedFleetId || 'None'}</td>
                </tr>
              ))}
              {routes.length === 0 && (
                <tr>
                  <td colSpan="5">No routes created yet.</td>
                </tr>
              )}
            </tbody>
          </table>

          {routes.length > 0 && fleet.length > 0 && (
            <div style={{ marginTop: '10px' }}>
              <div className="form-group">
                <label className="form-label">Assign Fleet to Route</label>
                <input
                  className="form-input"
                  type="number"
                  placeholder="Fleet ID"
                  value={assignFleetId}
                  onChange={e => setAssignFleetId(e.target.value)}
                  style={{ marginBottom: '5px' }}
                />
                <input
                  className="form-input"
                  type="number"
                  placeholder="Route ID"
                  value={assignRouteId}
                  onChange={e => setAssignRouteId(e.target.value)}
                  style={{ marginBottom: '5px' }}
                />
              </div>
              <button className="btn btn-success" onClick={handleAssign}>
                Assign
              </button>
            </div>
          )}
        </div>
      );
    }

    // 2.6) TransitMap: D3 visualization of stations & routes
    function TransitMap() {
      const ref = useRef();
      const tooltip = d3.select('#tooltip');

      useEffect(() => {
        const width = ref.current.clientWidth;
        const height = ref.current.clientHeight;
        const svg = d3
          .select(ref.current)
          .html('')
          .append('svg')
          .attr('width', width)
          .attr('height', height);

        // Draw stations as circles
        gameState.stations.forEach(st => {
          svg
            .append('circle')
            .attr('cx', st.x)
            .attr('cy', st.y)
            .attr('r', 8)
            .attr('fill', '#ff7f50')
            .attr('stroke', '#333')
            .attr('stroke-width', 1)
            .on('mouseover', function (event) {
              d3.select(this).attr('r', 12);
              tooltip
                .html(`${st.name} (ID: ${st.id})<br/>Maint: $${st.maintenanceCost}`)
                .style('visibility', 'visible')
                .style('left', event.pageX + 10 + 'px')
                .style('top', event.pageY + 10 + 'px');
            })
            .on('mousemove', function (event) {
              tooltip
                .style('left', event.pageX + 10 + 'px')
                .style('top', event.pageY + 10 + 'px');
            })
            .on('mouseout', function () {
              d3.select(this).attr('r', 8);
              tooltip.style('visibility', 'hidden');
            });
        });

        // Draw routes as lines connecting stops
        gameState.routes.forEach(rt => {
          const stops = rt.stops.map(id => gameState.stations.find(s => s.id === id));
          if (stops.length < 2) return;
          const lineGenerator = d3.line().x(d => d.x).y(d => d.y);
          svg
            .append('path')
            .datum(stops)
            .attr('d', lineGenerator)
            .attr('fill', 'none')
            .attr('stroke', rt.type === 'Bus' ? '#1e90ff' : rt.type === 'Tram' ? '#32cd32' : '#8b008b')
            .attr('stroke-width', 3)
            .attr('opacity', 0.7)
            .on('mouseover', function (event) {
              d3.select(this).attr('stroke-width', 5);
              tooltip
                .html(`Route "${rt.name}"<br/>Type: ${rt.type}<br/>Fare: $${rt.fare}`)
                .style('visibility', 'visible')
                .style('left', event.pageX + 10 + 'px')
                .style('top', event.pageY + 10 + 'px');
            })
            .on('mousemove', function (event) {
              tooltip
                .style('left', event.pageX + 10 + 'px')
                .style('top', event.pageY + 10 + 'px');
            })
            .on('mouseout', function () {
              d3.select(this).attr('stroke-width', 3);
              tooltip.style('visibility', 'hidden');
            });
        });
      }, [gameState.stations, gameState.routes]);

      return <div className="map-container" ref={ref}></div>;
    }

    // 2.7) RidershipChart: monthly ridership line chart
    function RidershipChart() {
      const ref = useRef();

      useEffect(() => {
        const data = gameState.history.ridership.map((r, i) => ({
          month: i + 1,
          riders: r
        }));
        if (data.length === 0) return;

        const margin = { top: 10, right: 30, bottom: 30, left: 50 };
        const width = ref.current.clientWidth - margin.left - margin.right;
        const height = ref.current.clientHeight - margin.top - margin.bottom;

        const svg = d3
          .select(ref.current)
          .html('')
          .append('svg')
          .attr('width', width + margin.left + margin.right)
          .attr('height', height + margin.top + margin.bottom)
          .append('g')
          .attr('transform', `translate(${margin.left},${margin.top})`);

        const x = d3
          .scaleLinear()
          .domain([1, data.length])
          .range([0, width]);
        const y = d3
          .scaleLinear()
          .domain([0, d3.max(data, d => d.riders) * 1.1])
          .range([height, 0]);

        svg
          .append('path')
          .datum(data)
          .attr('fill', 'none')
          .attr('stroke', '#1e90ff')
          .attr('stroke-width', 2)
          .attr(
            'd',
            d3
              .line()
              .x(d => x(d.month))
              .y(d => y(d.riders))
          );

        svg
          .append('g')
          .attr('transform', `translate(0,${height})`)
          .call(d3.axisBottom(x).ticks(5));
        svg.append('g').call(d3.axisLeft(y).ticks(5));
      }, [gameState.history.ridership]);

      return <div className="chart" ref={ref}></div>;
    }

    // 2.8) RevenueChart: monthly profit/cash chart
    function RevenueChart() {
      const ref = useRef();

      useEffect(() => {
        const cashData = gameState.history.cash.map((c, i) => ({
          month: i + 1,
          cash: c
        }));
        if (cashData.length === 0) return;

        const margin = { top: 10, right: 30, bottom: 30, left: 50 };
        const width = ref.current.clientWidth - margin.left - margin.right;
        const height = ref.current.clientHeight - margin.top - margin.bottom;

        const svg = d3
          .select(ref.current)
          .html('')
          .append('svg')
          .attr('width', width + margin.left + margin.right)
          .attr('height', height + margin.top + margin.bottom)
          .append('g')
          .attr('transform', `translate(${margin.left},${margin.top})`);

        const x = d3
          .scaleLinear()
          .domain([1, cashData.length])
          .range([0, width]);
        const y = d3
          .scaleLinear()
          .domain([0, d3.max(cashData, d => d.cash) * 1.1])
          .range([height, 0]);

        svg
          .append('path')
          .datum(cashData)
          .attr('fill', 'none')
          .attr('stroke', '#32cd32')
          .attr('stroke-width', 2)
          .attr(
            'd',
            d3
              .line()
              .x(d => x(d.month))
              .y(d => y(d.cash))
          );

        svg
          .append('g')
          .attr('transform', `translate(0,${height})`)
          .call(d3.axisBottom(x).ticks(5));
        svg.append('g').call(d3.axisLeft(y).ticks(5));
      }, [gameState.history.cash]);

      return <div className="chart" ref={ref}></div>;
    }

    // 2.9) EventLog: scrollable list of events
    function EventLog() {
      return (
        <div className="event-log">
          <div className="section-title">Event Log</div>
          {gameState.log.map((e, idx) => (
            <div key={idx} className="event-item">
              Month {e.month}: {e.text}
            </div>
          ))}
          {gameState.log.length === 0 && <p>No events yet.</p>}
        </div>
      );
    }

    // ----------- 3) Main App -----------
    function App() {
      const [started, setStarted] = useState(gameState.gameStarted);
      const [, updateState] = useState(); // to force re-render

      const refresh = () => {
        updateState({});
      };

      const handleStart = () => {
        gameState.reset();
        setStarted(true);
        refresh();
      };

      const handleNextMonth = () => {
        gameState.randomEvent();
        gameState.advanceMonth();
        refresh();
      };

      if (!started) {
        return <SetupModal onStart={handleStart} />;
      }

      return (
        <div className="container">
          <div className="header">
            <div className="header-title">{gameState.companyName} Transit Tycoon</div>
            <div className="stats-bar">
              <div className="stat-item">
                <div className="stat-value">Month {gameState.currentMonth}</div>
                <div className="stat-label">Time</div>
              </div>
              <div className="stat-item">
                <div className="stat-value">${gameState.cash.toLocaleString()}</div>
                <div className="stat-label">Cash</div>
              </div>
              <div className="stat-item">
                <div className="stat-value">${gameState.revenue.toLocaleString()}</div>
                <div className="stat-label">Revenue</div>
              </div>
              <div className="stat-item">
                <div className="stat-value">${gameState.expenses.toLocaleString()}</div>
                <div className="stat-label">Expenses</div>
              </div>
              <div className="stat-item">
                <div className="stat-value">${gameState.monthlyProfit.toLocaleString()}</div>
                <div className="stat-label">Profit</div>
              </div>
              <button className="btn btn-danger" onClick={handleNextMonth} disabled={gameState.gameOver}>
                Advance Month
              </button>
            </div>
          </div>

          <div className="main-content">
            <SidebarControls refresh={refresh} />

            <div className="central-panel">
              <div className="section-title">Transit Network Map</div>
              <TransitMap />

              <div className="section-title">Performance Charts</div>
              <RidershipChart />
              <RevenueChart />

              <EventLog />
            </div>

            <div className="right-panel">
              <StationPanel refresh={refresh} />
              <FleetPanel refresh={refresh} />
              <RoutePanel refresh={refresh} />
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
